using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Threading;
using System.Windows.Controls;
using System.ComponentModel;
using System.Diagnostics;
using System.Collections.ObjectModel;
using Dualshock4Customizer.Services;
using Dualshock4Customizer.Models;
using Dualshock4Customizer.Windows;

namespace Dualshock4Customizer
{
    public partial class MainWindow : Window
    {
        private DS4ControllerManager _manager;
        private ProfileManager _profileManager;
        private Dictionary<string, DS4LedService> _ledServices = new Dictionary<string, DS4LedService>();
        private Dictionary<string, DS4BatteryService> _batteryServices = new Dictionary<string, DS4BatteryService>();
        private Dictionary<string, DS4ConnectionService> _connectionWrappers = new Dictionary<string, DS4ConnectionService>();
        private Dictionary<string, DS4BatteryWarningService> _batteryWarnings = new Dictionary<string, DS4BatteryWarningService>();
        private Dictionary<string, DS4LedEffectService> _effectServices = new Dictionary<string, DS4LedEffectService>();
        
        private SystemTrayService _systemTray;
        private GameDetectionService _gameDetection;
        private DispatcherTimer _timer;
        
        private ObservableCollection<DS4Controller> _controllerList = new ObservableCollection<DS4Controller>();
        private ObservableCollection<DS4Profile> _profileList = new ObservableCollection<DS4Profile>();
        private DS4Controller _selectedController;

        public MainWindow()
        {
            InitializeComponent();
            ControllerListBox.ItemsSource = _controllerList;
            ProfileListBox.ItemsSource = _profileList;
            
            _profileManager = new ProfileManager();
            _profileManager.CreateDefaultProfiles();
            _profileManager.ProfilesChanged += (s, e) => LoadProfileList();
            LoadProfileList();
            
            InitializeServices();
            InitializeManager();
            Closing += MainWindow_Closing;
            StateChanged += MainWindow_StateChanged;
        }

        private void InitializeServices()
        {
            // Sistem tepsisi servisi
            _systemTray = new SystemTrayService(this, OnTrayProfileSelected);
            _systemTray.OnQuickAction += OnSystemTrayQuickAction;
            _systemTray.UpdateContextMenu(_profileManager.Profiles.ToArray());

            // Oyun algılama servisi
            _gameDetection = new GameDetectionService();
            _gameDetection.GameDetected += OnGameDetected;
        }

        private void OnTrayProfileSelected(DS4Profile profile)
        {
            if (_controllerList.Count == 0) return;

            Dispatcher.Invoke(() =>
            {
                foreach (var controller in _controllerList)
                {
                    profile.ApplyToController(controller);
                    ApplyColorToController(controller);
                }
                
                _systemTray.ShowBalloonTip("Profil Yüklendi", 
                    $"'{profile.ProfileName}' tüm kontrolcülere uygulandı!", 
                    System.Windows.Forms.ToolTipIcon.Info);
            });
        }

        private void OnSystemTrayQuickAction(object sender, QuickActionEventArgs e)
        {
            Dispatcher.Invoke(() =>
            {
                switch (e.ActionType)
                {
                    case QuickActionType.TurnOffAllLeds:
                        TurnOffAllLeds();
                        break;
                    case QuickActionType.RainbowEffect:
                        ApplyRainbowToAll();
                        break;
                }
            });
        }

        private void MainWindow_StateChanged(object sender, EventArgs e)
        {
            if (WindowState == WindowState.Minimized && MinimizeToTrayCheckbox != null && MinimizeToTrayCheckbox.IsChecked == true)
            {
                _systemTray.MinimizeToTray();
            }
        }

        private void OnGameDetected(object sender, GameDetectedEventArgs e)
        {
            Dispatcher.Invoke(() =>
            {
                var profile = _profileManager.Profiles.FirstOrDefault(p => 
                    p.AutoLoadForGame && p.LinkedGameProcess.Equals(e.ProcessName, StringComparison.OrdinalIgnoreCase));

                if (profile != null && _controllerList.Count > 0)
                {
                    foreach (var controller in _controllerList)
                    {
                        profile.ApplyToController(controller);
                        ApplyColorToController(controller);
                    }

                    _systemTray.ShowBalloonTip("Oyun Algılandı", 
                        $"{e.ProcessName}\n'{profile.ProfileName}' profili yüklendi!", 
                        System.Windows.Forms.ToolTipIcon.Info);

                    Debug.WriteLine($"?? Oyun profili otomatik yüklendi: {profile.ProfileName}");
                }
            });
        }

        private void LoadProfileList()
        {
            _profileList.Clear();
            foreach (var profile in _profileManager.Profiles)
            {
                _profileList.Add(profile);
            }
            _systemTray?.UpdateContextMenu(_profileManager.Profiles.ToArray());
        }

        private void InitializeManager()
        {
            _manager = new DS4ControllerManager();
            _manager.ControllerConnected += OnControllerConnected;
            _manager.ControllerDisconnected += OnControllerDisconnected;

            int count = _manager.ScanAndConnect();
            Debug.WriteLine($"?? {count} kontrolcü bulundu");
            
            if (count > 0)
            {
                _timer = new DispatcherTimer { Interval = TimeSpan.FromSeconds(3) };
                _timer.Tick += Timer_Tick;
                _timer.Start();
            }
            else
            {
                SelectedControllerTitle.Text = "? Kontrolcü bulunamadı";
                SelectedControllerStatus.Text = "Kontrolcüleri bağlayıp yeniden başlatın.\nDS4Windows kapalı olmalı!";
            }
        }

        private void Timer_Tick(object sender, EventArgs e)
        {
            _manager.ScanAndConnect();
            _manager.CleanupDisconnected();
            ReadAllBatteries();
            CheckBatteryWarnings();
        }

        private void CheckBatteryWarnings()
        {
            foreach (var kvp in _batteryWarnings)
            {
                kvp.Value.CheckBatteryLevel();
            }
        }

        private void OnControllerConnected(object sender, ControllerEventArgs e)
        {
            Dispatcher.Invoke(() =>
            {
                var controller = e.Controller;
                Debug.WriteLine($"? Kontrolcü bağlandı: {controller.DisplayName}");
                
                var connectionWrapper = new DS4ConnectionService();
                connectionWrapper.ConnectToExisting(controller.Device, controller.IsBluetooth);
                
                var ledService = new DS4LedService(connectionWrapper);
                var batteryService = new DS4BatteryService(connectionWrapper);
                var batteryWarning = new DS4BatteryWarningService(controller, ledService, 20);
                var effectService = new DS4LedEffectService(controller, ledService);
                
                batteryService.BatteryStatusChanged += (s, args) =>
                {
                    controller.BatteryPercent = args.Status.Percent;
                    controller.IsCharging = args.Status.IsCharging;
                };

                _connectionWrappers[controller.Id] = connectionWrapper;
                _ledServices[controller.Id] = ledService;
                _batteryServices[controller.Id] = batteryService;
                _batteryWarnings[controller.Id] = batteryWarning;
                _effectServices[controller.Id] = effectService;
                _controllerList.Add(controller);

                // Otomatik profil yükle (MAC adresine göre)
                AutoLoadProfile(controller);
                
                // Sistem tepsisi bildirimi
                _systemTray.ShowBalloonTip("Kontrolcü Bağlandı", 
                    $"{controller.DisplayName} başarıyla bağlandı!", 
                    System.Windows.Forms.ToolTipIcon.Info);
            });
        }

        private void AutoLoadProfile(DS4Controller controller)
        {
            var profile = _profileManager.GetProfileByMacAddress(controller.Id);
            if (profile != null)
            {
                profile.ApplyToController(controller);
                ApplyProfileWithEffects(controller, profile);
                _profileManager.SaveProfiles();
                Debug.WriteLine($"? Profil otomatik yüklendi: {profile.ProfileName}");
                
                controller.ActiveProfileName = profile.ProfileName;
            }
            else
            {
                ApplyColorToController(controller);
            }
        }

        private void ApplyProfileWithEffects(DS4Controller controller, DS4Profile profile)
        {
            ApplyColorToController(controller);

            if (_effectServices.TryGetValue(controller.Id, out var effectService))
            {
                if (profile.EffectType != LedEffectType.None)
                {
                    effectService.EffectSpeed = profile.EffectSpeed;
                    effectService.StartEffect(profile.EffectType);
                }
                else
                {
                    effectService.StopEffect();
                }
            }
        }

        private void OnControllerDisconnected(object sender, ControllerEventArgs e)
        {
            Dispatcher.Invoke(() =>
            {
                // Servisleri temizle
                if (_effectServices.TryGetValue(e.Controller.Id, out var effectService))
                {
                    effectService.Dispose();
                    _effectServices.Remove(e.Controller.Id);
                }

                _connectionWrappers.Remove(e.Controller.Id);
                _ledServices.Remove(e.Controller.Id);
                _batteryServices.Remove(e.Controller.Id);
                _batteryWarnings.Remove(e.Controller.Id);
                _controllerList.Remove(e.Controller);
                
                if (_selectedController == e.Controller)
                {
                    _selectedController = null;
                    SettingsPanel.IsEnabled = false;
                    SelectedControllerTitle.Text = "Kontrolcü kesildi";
                }
            });
        }

        private void ReadAllBatteries()
        {
            foreach (var kvp in _batteryServices.ToList())
            {
                try { kvp.Value.ReadBatteryStatus(); }
                catch { }
            }
        }

        private void ControllerListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            _selectedController = ControllerListBox.SelectedItem as DS4Controller;
            
            if (_selectedController == null)
            {
                SettingsPanel.IsEnabled = false;
                SelectedControllerTitle.Text = "Kontrolcü seçin";
                SelectedControllerStatus.Text = "";
                return;
            }

            SettingsPanel.IsEnabled = true;
            SelectedControllerTitle.Text = $"?? {_selectedController.DisplayName}";
            SelectedControllerStatus.Text = $"?? Pil: {_selectedController.BatteryPercent}%\n" +
                                          $"{(_selectedController.IsBluetooth ? "?? Bluetooth" : "?? USB")}\n" +
                                          $"?? ID: {_selectedController.Id.Substring(0, Math.Min(20, _selectedController.Id.Length))}...";

            LoadControllerSettings(_selectedController);
        }

        private void LoadControllerSettings(DS4Controller controller)
        {
            string colorTag = controller.SelectedColor;
            foreach (ComboBoxItem item in ColorSelector.Items)
            {
                if (item.Tag.ToString() == colorTag)
                {
                    ColorSelector.SelectedItem = item;
                    break;
                }
            }

            VibrationCheckbox.IsChecked = controller.VibrationEnabled;
            FlashCheckbox.IsChecked = controller.PulseEnabled;
            UpdateNotificationText();
        }

        private void ColorSelector_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (_selectedController == null) return;
            ComboBoxItem selectedItem = ColorSelector.SelectedItem as ComboBoxItem;
            if (selectedItem == null) return;

            string colorName = selectedItem.Tag.ToString();
            _selectedController.SelectedColor = colorName;
            
            switch (colorName)
            {
                case "Kirmizi": _selectedController.LedR = 255; _selectedController.LedG = 0; _selectedController.LedB = 0; break;
                case "Yesil": _selectedController.LedR = 0; _selectedController.LedG = 255; _selectedController.LedB = 0; break;
                case "Mavi": _selectedController.LedR = 0; _selectedController.LedG = 0; _selectedController.LedB = 255; break;
                case "Turuncu": _selectedController.LedR = 255; _selectedController.LedG = 165; _selectedController.LedB = 0; break;
                case "Beyaz": _selectedController.LedR = 255; _selectedController.LedG = 255; _selectedController.LedB = 255; break;
                case "Kapali": _selectedController.LedR = 0; _selectedController.LedG = 0; _selectedController.LedB = 0; break;
                case "OzelRenk": OpenColorPicker(); return;
            }

            ApplyColorToController(_selectedController);
        }

        private void OpenColorPicker()
        {
            if (_selectedController == null) return;

            var colorPicker = new ColorPickerWindow(_selectedController.LedR, _selectedController.LedG, _selectedController.LedB);
            if (colorPicker.ShowDialog() == true)
            {
                _selectedController.LedR = colorPicker.SelectedR;
                _selectedController.LedG = colorPicker.SelectedG;
                _selectedController.LedB = colorPicker.SelectedB;
                _selectedController.SelectedColor = "OzelRenk";
                ApplyColorToController(_selectedController);
            }
        }

        private void NotificationCheckbox_Changed(object sender, RoutedEventArgs e)
        {
            if (_selectedController == null) return;
            _selectedController.VibrationEnabled = VibrationCheckbox.IsChecked ?? false;
            _selectedController.PulseEnabled = FlashCheckbox.IsChecked ?? false;
            ApplyColorToController(_selectedController);
            UpdateNotificationText();
        }

        private void ApplyColorToController(DS4Controller controller)
        {
            if (!_ledServices.TryGetValue(controller.Id, out var ledService))
                return;

            byte rumble = controller.VibrationEnabled ? (byte)0xFF : (byte)0x00;
            bool flash = controller.PulseEnabled;

            try
            {
                ledService.SetLedColor(controller.LedR, controller.LedG, controller.LedB, rumble, flash);
                Debug.WriteLine($"?? {controller.DisplayName}: RGB({controller.LedR},{controller.LedG},{controller.LedB})");
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"? LED hatası ({controller.DisplayName}): {ex.Message}");
            }
        }

        // YENİ ÖZELLIK BUTONLARI

        private void RgbColorPickerButton_Click(object sender, RoutedEventArgs e)
        {
            OpenColorPicker();
        }

        private void EffectRainbowButton_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedController == null) return;
            
            if (_effectServices.TryGetValue(_selectedController.Id, out var effectService))
            {
                effectService.StartEffect(LedEffectType.Rainbow);
                MessageBox.Show("?? Rainbow efekti başlatıldı!", "Efekt", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void EffectBreathingButton_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedController == null) return;
            
            if (_effectServices.TryGetValue(_selectedController.Id, out var effectService))
            {
                effectService.StartEffect(LedEffectType.Breathing);
                MessageBox.Show("?? Breathing efekti başlatıldı!", "Efekt", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void EffectStopButton_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedController == null) return;
            
            if (_effectServices.TryGetValue(_selectedController.Id, out var effectService))
            {
                effectService.StopEffect();
                ApplyColorToController(_selectedController);
                MessageBox.Show("?? Efekt durduruldu!", "Efekt", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void ExportProfileButton_Click(object sender, RoutedEventArgs e)
        {
            var selectedProfile = ProfileListBox.SelectedItem as DS4Profile;
            if (selectedProfile == null)
            {
                MessageBox.Show("Dışa aktarılacak profili seçin!", "Uyarı", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (ProfileImportExportService.ExportProfile(selectedProfile))
            {
                MessageBox.Show("Profil başarıyla dışa aktarıldı!", "Başarılı", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void ImportProfileButton_Click(object sender, RoutedEventArgs e)
        {
            var profile = ProfileImportExportService.ImportProfile(out bool success);
            if (success && profile != null)
            {
                _profileManager.UpdateProfile(profile);
                MessageBox.Show($"'{profile.ProfileName}' profili içe aktarıldı!", "Başarılı", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void ToggleGameDetectionButton_Click(object sender, RoutedEventArgs e)
        {
            if (_gameDetection.IsEnabled)
            {
                _gameDetection.Stop();
                GameDetectionStatusText.Text = "Oyun algılama: Kapalı";
            }
            else
            {
                _gameDetection.Start();
                GameDetectionStatusText.Text = "Oyun algılama: Açık";
            }
        }

        // MEVCUT PROFIL BUTONLARI

        private void SaveProfileButton_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedController == null)
            {
                MessageBox.Show("Önce bir kontrolcü seçin!", "Uyarı", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var dialog = new ProfileNameDialog();
            if (dialog.ShowDialog() == true)
            {
                string profileName = dialog.ProfileName;
                
                if (!_profileManager.IsProfileNameUnique(profileName))
                {
                    var result = MessageBox.Show($"'{profileName}' profili zaten var. Üzerine yazılsın mı?", 
                                               "Profil Var", MessageBoxButton.YesNo, MessageBoxImage.Question);
                    if (result != MessageBoxResult.Yes)
                        return;
                }

                var profile = DS4Profile.FromController(_selectedController, profileName);
                _profileManager.UpdateProfile(profile);
                
                MessageBox.Show($"'{profileName}' profili kaydedildi!", "Başarılı", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void LoadProfileButton_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedController == null)
            {
                MessageBox.Show("Önce bir kontrolcü seçin!", "Uyarı", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var selectedProfile = ProfileListBox.SelectedItem as DS4Profile;
            if (selectedProfile == null)
            {
                MessageBox.Show("Profil listesinden bir profil seçin!", "Uyarı", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            selectedProfile.ApplyToController(_selectedController);
            LoadControllerSettings(_selectedController);
            ApplyProfileWithEffects(_selectedController, selectedProfile);
            _profileManager.SaveProfiles();
            
            MessageBox.Show($"'{selectedProfile.ProfileName}' profili yüklendi!", "Başarılı", MessageBoxButton.OK, MessageBoxImage.Information);
        }

        private void DeleteProfileButton_Click(object sender, RoutedEventArgs e)
        {
            var selectedProfile = ProfileListBox.SelectedItem as DS4Profile;
            if (selectedProfile == null)
            {
                MessageBox.Show("Silinecek profili seçin!", "Uyarı", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var result = MessageBox.Show($"'{selectedProfile.ProfileName}' profilini silmek istediğinize emin misiniz?", 
                                       "Profil Sil", MessageBoxButton.YesNo, MessageBoxImage.Question);
            if (result == MessageBoxResult.Yes)
            {
                _profileManager.DeleteProfile(selectedProfile.ProfileName);
                MessageBox.Show("Profil silindi!", "Başarılı", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void LinkProfileButton_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedController == null)
            {
                MessageBox.Show("Önce bir kontrolcü seçin!", "Uyarı", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var selectedProfile = ProfileListBox.SelectedItem as DS4Profile;
            if (selectedProfile == null)
            {
                MessageBox.Show("Eşleştirilecek profili seçin!", "Uyarı", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            selectedProfile.MacAddress = _selectedController.Id;
            _profileManager.SaveProfiles();
            
            MessageBox.Show($"'{selectedProfile.ProfileName}' profili bu kontrolcü ile eşleştirildi!\nBir sonraki bağlantıda otomatik yüklenecek.", 
                          "Eşleştirme Başarılı", MessageBoxButton.OK, MessageBoxImage.Information);
        }

        private void ApplyToAllButton_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedController == null) return;

            foreach (var controller in _controllerList)
            {
                controller.LedR = _selectedController.LedR;
                controller.LedG = _selectedController.LedG;
                controller.LedB = _selectedController.LedB;
                controller.VibrationEnabled = _selectedController.VibrationEnabled;
                controller.PulseEnabled = _selectedController.PulseEnabled;
                controller.SelectedColor = _selectedController.SelectedColor;
                ApplyColorToController(controller);
            }

            MessageBox.Show($"{_selectedController.DisplayName} ayarları tüm kontrolcülere uygulandı!", 
                          "Başarılı", MessageBoxButton.OK, MessageBoxImage.Information);
        }

        private void AutoColorButton_Click(object sender, RoutedEventArgs e)
        {
            var colors = new[] {
                (255, 0, 0), (0, 255, 0), (0, 0, 255),
                (255, 255, 0), (255, 0, 255), (0, 255, 255)
            };

            for (int i = 0; i < _controllerList.Count; i++)
            {
                var controller = _controllerList[i];
                var color = colors[i % colors.Length];
                controller.LedR = (byte)color.Item1;
                controller.LedG = (byte)color.Item2;
                controller.LedB = (byte)color.Item3;
                ApplyColorToController(controller);
            }

            MessageBox.Show("Otomatik renk gradyanı uygulandı!", "Başarılı", MessageBoxButton.OK, MessageBoxImage.Information);
        }

        private void TurnOffAllLeds()
        {
            foreach (var controller in _controllerList)
            {
                controller.LedR = 0;
                controller.LedG = 0;
                controller.LedB = 0;
                ApplyColorToController(controller);
            }
        }

        private void ApplyRainbowToAll()
        {
            foreach (var controller in _controllerList)
            {
                if (_effectServices.TryGetValue(controller.Id, out var effectService))
                {
                    effectService.StartEffect(LedEffectType.Rainbow);
                }
            }
        }

        private void UpdateNotificationText()
        {
            if (_selectedController == null) return;
            bool vib = _selectedController.VibrationEnabled;
            bool pulse = _selectedController.PulseEnabled;
            NotificationStatusText.Text = $"{(vib ? "?? Kalp ritmi aktif" : "Titreşim kapalı")}\n{(pulse ? "?? PS4 pulse aktif" : "Pulse kapalı")}";
        }

        private void MainWindow_Closing(object sender, CancelEventArgs e)
        {
            _timer?.Stop();
            _gameDetection?.Dispose();
            
            foreach (var effectService in _effectServices.Values)
            {
                try { effectService?.Dispose(); }
                catch { }
            }
            
            foreach (var ledService in _ledServices.Values)
            {
                try { ledService.TurnOffLed(); }
                catch { }
            }
            
            System.Threading.Thread.Sleep(100);
            _manager?.Dispose();
            
            foreach (var wrapper in _connectionWrappers.Values)
                wrapper?.Dispose();
            
            _systemTray?.Dispose();
        }
    }

    // Profil isim dialog
    public class ProfileNameDialog : Window
    {
        public string ProfileName { get; private set; }
        private System.Windows.Controls.TextBox _nameTextBox;

        public ProfileNameDialog()
        {
            Title = "Profil Adı";
            Width = 350;
            Height = 150;
            WindowStartupLocation = WindowStartupLocation.CenterScreen;

            var panel = new StackPanel { Margin = new Thickness(20) };
            panel.Children.Add(new TextBlock { Text = "Profil Adı:", Margin = new Thickness(0, 0, 0, 5) });
            
            _nameTextBox = new System.Windows.Controls.TextBox { Margin = new Thickness(0, 0, 0, 15) };
            panel.Children.Add(_nameTextBox);

            var btnPanel = new StackPanel { Orientation = Orientation.Horizontal, HorizontalAlignment = HorizontalAlignment.Right };
            var okBtn = new Button { Content = "Tamam", Width = 75, Margin = new Thickness(0, 0, 10, 0) };
            var cancelBtn = new Button { Content = "İptal", Width = 75 };
            
            okBtn.Click += (s, e) => { ProfileName = _nameTextBox.Text.Trim(); DialogResult = true; };
            cancelBtn.Click += (s, e) => { DialogResult = false; };
            
            btnPanel.Children.Add(okBtn);
            btnPanel.Children.Add(cancelBtn);
            panel.Children.Add(btnPanel);
            
            Content = panel;
            _nameTextBox.Focus();
        }
    }
}

